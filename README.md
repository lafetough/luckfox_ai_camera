# Структурированная архитектура проекта

## Обзор

Ваш код переструктурирован в систему классов для лучшей организации и переиспользования. Каждый класс отвечает за конкретную часть функциональности.

## Компоненты архитектуры

### 1. **VideoProcessing** (video_processing.h/cc)
Отвечает за обработку видео изображений:
- `ImagePreprocessor`: Подготовка изображений для модели (letterbox, маппинг координат)
- `DetectionDrawer`: Рисование ограничивающих прямоугольников и меток

### 2. **HardwareManager** (hardware_manager.h/cc)
Управление аппаратными ресурсами:
- `MemoryPool`: Управление пулом памяти DMA
- `VideoInput`: Захват видеопотока с камеры
- `VideoEncoder`: Кодирование видео в H264

### 3. **MLInference** (ml_inference.h/cc)
Работа с моделью машинного обучения:
- `YOLOv5Detector`: Инициализация, запуск инференса и пост-обработки

### 4. **RTSPStreaming** (rtsp_streaming.h/cc)
Потоковая трансляция по RTSP:
- `RTSPServer`: Создание RTSP сервера и передача видеопотока

### 5. **VideoCaptureEngine** (video_capture_engine.h/cc)
Работа с камерой и ISP:
- `ImageConverter`: Преобразование форматов видео
- `CameraISP`: Инициализация и управление ISP

### 6. **Application** (application.h/cc)
Главный координатор приложения:
- `ObjectDetectionApplication`: Интеграция всех компонентов в единое приложение

### 7. **Main** (main.cc)
Точка входа приложения с обработкой сигналов

## Преимущества архитектуры

✅ **Модульность** - каждый класс имеет одну ответственность
✅ **Переиспользуемость** - компоненты можно использовать отдельно
✅ **Тестируемость** - легко писать unit-тесты для каждого класса
✅ **Масштабируемость** - просто добавлять новые возможности
✅ **Управление ошибками** - ясная обработка ошибок с bool флагами
✅ **Управление ресурсами** - деструкторы автоматически очищают ресурсы

## Диаграмма взаимодействия

```
main.cc
    ↓
ObjectDetectionApplication
    ├─ CameraISP (камера)
    ├─ MemoryPool (память)
    ├─ VideoInput (захват)
    ├─ VideoEncoder (кодирование)
    ├─ YOLOv5Detector (инференс)
    ├─ ImagePreprocessor (подготовка)
    ├─ DetectionDrawer (рисование)
    └─ RTSPServer (трансляция)
```

## Использование

```cpp
// Создание приложения
ObjectDetectionApplication app(720, 480, "./model/yolov5.rknn");

// Инициализация
if (app.initialize()) {
    // Основной цикл
    app.run();
    
    // Завершение
    app.shutdown();
}
```

## Изменения в коде

- ✅ Все глобальные переменные преобразованы в члены классов
- ✅ Все функции перемещены в соответствующие методы классов
- ✅ Добавлены конструкторы и деструкторы
- ✅ Добавлены флаги инициализации для безопасности
- ✅ Добавлены методы инициализации и очистки
- ✅ Добавлены методы доступа к членам (getters)
- ✅ Логика разделена на логические блоки
